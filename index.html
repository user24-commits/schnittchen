<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schnittchen | Der Planer</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=JetBrains+Mono:wght@500&display=swap');

    :root{
      --dark: #3b424c;
      --red:  #c0392b;
      --bg: #f1f5f9;
      --text: #1e293b;
      --blue: #3b82f6;
      --blueBg: #eff6ff;
    }

    html, body { height: 100%; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); overflow: auto; }

    /* 13" Kompaktheit */
    header { padding-top: 1.2rem !important; padding-bottom: 1.0rem !important; }
    .card { border-radius: 1.1rem; }
    .card.p-6 { padding: 1.0rem !important; }
    .gap-6 { gap: 1.0rem !important; }
    .space-y-5 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.85rem !important; }
    .py-4 { padding-top: 0.75rem !important; padding-bottom: 0.75rem !important; }

    /* Inputs */
    input, select, textarea {
      font-family: 'JetBrains Mono', monospace;
      text-align: center;
      width: 100%;
      height: 44px;
      padding: 0.65rem;
      border: 1px solid #cbd5e1;
      border-radius: 0.6rem;
      background: #ffffff;
      outline: none;
      transition: all 0.12s;
      appearance: none;
      -moz-appearance: textfield;
      user-select: text;
      caret-color: var(--blue);
    }
    textarea{
      height: auto;
      min-height: 0;
      text-align: left;
      padding: 1.15rem 1.15rem 1.15rem 1.35rem; /* nicht so nah links */
      line-height: 1.35;
      white-space: pre;
      resize: none;
    }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* One-click active style (blau markiert) */
    .oneclick-active{
      border-color: var(--blue) !important;
      background: var(--blueBg) !important;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15) !important;
    }

    label {
      display: block;
      font-size: 0.7rem;
      font-weight: 800;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
      text-align: center;
    }

    .card {
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* Toggle rows */
    .toggle-row{
      display:flex;
      gap:0.35rem;
      background: #eef2f7;
      border: 1px solid #e2e8f0;
      border-radius: 0.95rem;
      padding: 0.28rem;
      align-items: stretch;
      height: 44px;
    }
    .toggle-btn{
      flex:1;
      border-radius: 0.75rem;
      font-weight: 900;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(255,255,255,0.9);
      color:#475569;
      border: 1px solid rgba(226,232,240,1);
      transition: all 0.15s;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 100%;
      padding: 0 0.6rem;
      user-select: none;
    }
    .toggle-btn.active{
      background: var(--dark);
      color:white;
      border-color: var(--dark);
      box-shadow: inset 0 -3px 0 var(--red);
    }

    /* Cleaner Unit Row */
    .unit-row{
      display:flex;
      gap:0.35rem;
      background:#eef2f7;
      border:1px solid #e2e8f0;
      border-radius:0.95rem;
      padding:0.28rem;
      height:44px;
      align-items:stretch;
    }
    .btn-pill{
      flex:1;
      height:100%;
      padding:0 0.6rem;
      border:1px solid rgba(226,232,240,1);
      background:rgba(255,255,255,0.9);
      color:#475569;
      border-radius:0.75rem;
      font-weight:900;
      font-size:0.7rem;
      letter-spacing:0.08em;
      text-transform:uppercase;
      transition: all 0.15s;
      user-select:none;
    }
    .btn-pill.active{
      background:var(--dark);
      border-color:var(--dark);
      color:#fff;
      box-shadow: inset 0 -3px 0 var(--red);
    }

    /* Swap-Button (Länge/Breite) */
    .swap-btn{
      width: 44px;
      height: 44px;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all .15s;
      user-select:none;
    }
    .swap-btn:hover{
      border-color: #cbd5e1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .swap-btn:active{ transform: translateY(1px); }
    .swap-icon{ width: 20px; height: 20px; stroke: var(--dark); stroke-width: 2.2; fill: none; }

    /* Action Buttons */
    .action-btn {
      width: 100%;
      padding: 0.78rem 1rem;
      border-radius: 0.8rem;
      font-size: 0.7rem;
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      transition: all 0.15s;
      border: 1px solid #e2e8f0;
      background: #f1f5f9;
      color: #475569;
    }
    .action-btn.active {
      background: var(--dark);
      border-color: var(--dark);
      color: white;
      box-shadow: inset 0 -3px 0 var(--red);
    }

    .lang-btn {
      font-size: 10px;
      font-weight: 900;
      padding: 0.25rem 0.75rem;
      border-radius: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      transition: all 0.15s;
    }
    .lang-btn.active { background: var(--dark); color: white; box-shadow: inset 0 -3px 0 var(--red); }
    .lang-btn.inactive { background: #e2e8f0; color: #475569; }

    .metric-card {
      background: #f8fafc;
      border: 2px dashed #e2e8f0;
      border-radius: 1.2rem;
    }

    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 800;
      color: #475569;
      font-size: 1.15rem;
      line-height: 1.1;
    }

    .metric-title {
      font-size: 10px;
      font-weight: 900;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.35rem;
      text-align: center;
    }

    /* Layout */
    .app { height: 100%; display: flex; flex-direction: column; }
    .main { flex: 1; overflow: auto; }
    .gridWrap { height: auto; overflow: visible; }

    /* Panels */
    .panel-500{ height: 500px; min-height: 500px; overflow: auto; }

    .list-card { display:flex; flex-direction: column; height: 500px; min-height: 500px; }
    .list-grow { flex: 1; display:flex; flex-direction: column; min-height: 0; gap: 0.6rem; }
    #cut-list-text { flex: 1; min-height: 0; }
  </style>
</head>

<body>
<div class="app">

  <header class="text-center flex flex-col items-center">
    <img src="uploaded file ChatGPT Image 18. Feb. 2026, 17_14_05.jpg" alt="Schnittchen" class="max-w-[250px] mb-2">
    <div class="text-center mb-2">
      <div class="text-2xl font-black tracking-tight text-slate-900" id="hdr-title">Schnittchen</div>
      <div class="text-slate-500 font-semibold" id="hdr-sub">Der smarte Zuschnitt- & Box-Planer</div>
    </div>

    <div class="flex gap-2">
      <button onclick="setLang('de')" id="l-de" class="lang-btn active">DE</button>
      <button onclick="setLang('en')" id="l-en" class="lang-btn inactive">EN</button>
    </div>
  </header>

  <div class="main">
    <div class="max-w-7xl mx-auto px-4 h-full">
      <div class="gridWrap">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start h-full">

          <!-- LEFT: Inputs -->
          <div class="lg:col-span-4 card p-6 space-y-5 panel-500">

            <div>
              <label id="lbl-unit">Maße</label>

              <!-- Units: mm | cm | inch -->
              <div class="unit-row mb-2">
                <button onclick="setUnit('mm')" id="u-mm" class="btn-pill active">MM</button>
                <button onclick="setUnit('cm')" id="u-cm" class="btn-pill">CM</button>
                <button onclick="setUnit('inch')" id="u-inch" class="btn-pill">INCH</button>
              </div>

              <!-- Toggle: Außenmaß | Innenmaß -->
              <div class="toggle-row" role="group" aria-label="Maß-Referenz">
                <button type="button" id="t-outside" class="toggle-btn active" onclick="setMode('outside')">Außenmaß</button>
                <button type="button" id="t-inside" class="toggle-btn" onclick="setMode('inside')">Innenmaß</button>
              </div>

              <!-- hidden select bleibt für bestehende Logik -->
              <select id="type" onchange="calculate()" class="hidden">
                <option value="outside" id="opt-outside">Außenmaß (Standard)</option>
                <option value="inside" id="opt-inside">Innenmaß (Lichtes Maß)</option>
              </select>
            </div>

            <!-- Menge + Länge/Breite/Höhe in EINER Linie -->
            <div class="py-4 border-y border-slate-100">
              <div class="grid grid-cols-12 gap-3 items-end">
                <div class="col-span-2">
                  <label id="lbl-qty">Menge</label>
                  <input type="number" id="qty" value="1" min="1" step="1" oninput="calculate()">
                </div>

                <div class="col-span-3">
                  <label id="lbl-len">Länge</label>
                  <input type="number" id="length" value="400" min="0" step="0.1" oninput="onDimInput('length'); calculate()">
                </div>

                <div class="col-span-1 flex items-end justify-center">
                  <button class="swap-btn" onclick="swapLW()" title="Länge ↔ Breite" aria-label="Länge und Breite tauschen">
                    <svg class="swap-icon" viewBox="0 0 24 24">
                      <path d="M7 7h12M7 7l3-3M7 7l3 3"></path>
                      <path d="M17 17H5m12 0-3-3m3 3-3 3"></path>
                    </svg>
                  </button>
                </div>

                <div class="col-span-3">
                  <label id="lbl-width">Breite</label>
                  <input type="number" id="width" value="300" min="0" step="0.1" oninput="onDimInput('width'); calculate()">
                </div>

                <div class="col-span-3">
                  <label id="lbl-height">Höhe</label>
                  <input type="number" id="height" value="150" min="0" step="0.1" oninput="calculate()">
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label id="lbl-btype">Boden</label>

                <div class="toggle-row" role="group" aria-label="Boden-Option">
                  <button type="button" id="t-binside" class="toggle-btn active" onclick="setBottom('inside')">innen</button>
                  <button type="button" id="t-bbottom" class="toggle-btn" onclick="setBottom('bottom')">aussen</button>
                </div>

                <select id="bottom-type" onchange="calculate()" class="hidden">
                  <option value="inside" id="opt-binside">Boden Innen</option>
                  <option value="bottom" id="opt-bbottom">Boden Außen</option>
                </select>
              </div>

              <div>
                <label id="lbl-bthick">Bodenstärke</label>
                <input type="number" id="bottom-thick" value="18" min="0" step="0.1" oninput="calculate()">
              </div>
            </div>

            <!-- Material & Wandstärke in EINER Linie -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label id="lbl-thick">Wandstärke</label>
                <input type="number" id="thickness" value="18" min="0" step="0.1" oninput="calculate()">
              </div>
              <div>
                <label id="lbl-wood">Material</label>
                <input type="text" id="wood-type" value="Multiplex Birke" oninput="calculate()">
              </div>
            </div>
          </div>

          <!-- MIDDLE: Stückliste + Copy -->
          <div class="lg:col-span-4 card p-6 list-card">
            <div class="list-grow">
              <h2 class="font-black uppercase text-slate-400 text-[10px] tracking-widest text-center" id="lbl-list">
                Stückliste (Berechnet)
              </h2>

              <textarea id="cut-list-text" readonly></textarea>
            </div>

            <div class="mt-3 pt-3 border-t space-y-2">
              <button id="btn-copy" onclick="copyTableExcel()" class="action-btn">Tabelle kopieren (Numbers/Excel)</button>
              <button id="btn-mail" onclick="copyEmail()" class="action-btn">Mail (TXT)</button>
            </div>
          </div>

          <!-- RIGHT: 3D -->
          <div class="lg:col-span-4">
            <div class="bg-slate-900 rounded-2xl overflow-hidden h-[500px] shadow-xl relative border-b-8" style="border-color: var(--red);">
              <div id="canvas-container" class="w-full h-full"></div>
            </div>
          </div>

          <!-- BOTTOM METRICS -->
          <div class="lg:col-span-12 metric-card p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-stretch">
            <div class="card p-4 flex flex-col justify-center">
              <div class="metric-title" id="lbl-vol">Volumen / Box</div>
              <div class="text-center metric-value" id="val-vol">0.00 L</div>
            </div>

            <div class="card p-4 flex flex-col justify-center">
              <div class="metric-title" id="lbl-area">Materialbedarf</div>
              <div class="text-center metric-value" id="val-area">0.00 m²</div>
            </div>

            <div class="card p-4 flex flex-col justify-center">
              <div class="metric-title" id="lbl-price-label">Preis / m²</div>
              <input type="number" id="price-sqm" value="49.51" min="0" step="0.01" oninput="calculate()">
            </div>

            <div class="card p-4 flex flex-col justify-center">
              <div class="metric-title" id="lbl-total">Gesamtpreis</div>
              <div class="text-center metric-value" id="val-price">0.00 €</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<script>
  let scene, camera, renderer, controls, parts = [];
  let unit = 'mm';
  let lang = 'de';

  // Maserung: erstes eingegebenes Maß definiert Richtung
  let grainAxis = null; // 'x' | 'z'
  let woodTex = null;
  let woodMat = null;
  let edgeMat = null;

  const dict = {
    de: {
      title: "Schnittchen",
      sub: "Der smarte Zuschnitt- & Box-Planer",
      unit: "Maße",
      outside: "Außenmaß (Standard)",
      inside: "Innenmaß (Lichtes Maß)",
      qty: "Menge",
      thick: "Wandstärke",
      len: "Länge",
      width: "Breite",
      height: "Höhe",
      btype: "Boden",
      binside: "Boden Innen",
      bbottom: "Boden Außen",
      bthick: "Bodenstärke",
      wood: "Material",
      list: "Stückliste (Berechnet)",
      vol: "Volumen / Box",
      area: "Materialbedarf",
      "price-label": "Preis / m²",
      total: "Gesamtpreis",
      copy: "Tabelle kopieren (Numbers/Excel)",
      mail: "Mail (TXT)",
      fr: "Front/Rück",
      sides: "Seiten",
      bottom: "Boden",
      copied: "Kopiert!",
      mailcopied: "Mail-Text kopiert!",
      outsideShort: "Außenmaß",
      insideShort: "Innenmaß",
      binsideShort: "innen",
      bbottomShort: "aussen",
      tableHeader: "Menge\tTeil\tLänge\tBreite\tMaße\tMaterial"
    },
    en: {
      title: "Schnittchen",
      sub: "Smart cut list & box planner",
      unit: "Dimensions",
      outside: "Outside dims (default)",
      inside: "Inside dims (clear)",
      qty: "Quantity",
      thick: "Wall thickness",
      len: "Length",
      width: "Width",
      height: "Height",
      btype: "Bottom",
      binside: "Inside bottom",
      bbottom: "Outside bottom",
      bthick: "Bottom thickness",
      wood: "Material",
      list: "Cutting List (Calculated)",
      vol: "Volume / box",
      area: "Material (area)",
      "price-label": "Price / m²",
      total: "Total price",
      copy: "Copy table (Numbers/Excel)",
      mail: "Email (TXT)",
      fr: "Front/Back",
      sides: "Sides",
      bottom: "Bottom",
      copied: "Copied!",
      mailcopied: "Email text copied!",
      outsideShort: "Outside",
      insideShort: "Inside",
      binsideShort: "inside",
      bbottomShort: "outside",
      tableHeader: "Qty\tPart\tLength\tWidth\tDims\tMaterial"
    }
  };

  // --- Units
  const factorToMM = (u) => (u === 'mm' ? 1 : (u === 'cm' ? 10 : 25.4));

  function digitsForUnit(u){
    if (u === 'mm') return 0;     // mm: keine Nachkommastellen
    if (u === 'cm') return 1;     // cm: 1 Nachkommastelle (falls nötig)
    if (u === 'inch') return 3;   // inch: wie gehabt
    return 1;
  }

  function fmt(n) {
    if (!isFinite(n)) return "0";
    const d = digitsForUnit(unit);
    const s = Number(n).toFixed(d);
    return (d === 0) ? s : s.replace(/\.?0+$/, (m) => m === '.' ? '' : m);
  }

  function setLang(l) {
    lang = l;
    document.getElementById('l-de').className = l === 'de' ? 'lang-btn active' : 'lang-btn inactive';
    document.getElementById('l-en').className = l === 'en' ? 'lang-btn active' : 'lang-btn inactive';

    const d = dict[lang];
    document.getElementById('hdr-title').innerText = d.title;
    document.getElementById('hdr-sub').innerText = d.sub;

    const keys = Object.keys(d);
    keys.forEach(key => {
      const el = document.getElementById('lbl-' + key) || document.getElementById('opt-' + key);
      if (el) el.innerText = d[key];
    });

    document.getElementById('t-outside').innerText = d.outsideShort || d.outside;
    document.getElementById('t-inside').innerText  = d.insideShort  || d.inside;
    document.getElementById('t-binside').innerText = d.binsideShort || d.binside;
    document.getElementById('t-bbottom').innerText = d.bbottomShort || d.bbottom;

    document.getElementById('btn-copy').innerText = d.copy;
    document.getElementById('btn-mail').innerText = d.mail;

    calculate();
  }

  function setUnit(u) {
    if (u === unit) return;

    const oldF = factorToMM(unit);
    const newF = factorToMM(u);
    const ratio = oldF / newF;

    ['length','width','height','thickness','bottom-thick'].forEach(id => {
      const el = document.getElementById(id);
      const v = parseFloat(el.value);
      if (isFinite(v)) {
        const d = digitsForUnit(u);
        el.value = (v * ratio).toFixed(d).replace(/\.?0+$/, (m)=> m==='.'?'':m);
      }
    });

    unit = u;
    ['mm','cm','inch'].forEach(x => {
      const b = document.getElementById('u-' + x);
      if (b) b.classList.remove('active');
    });
    document.getElementById('u-' + u).classList.add('active');

    calculate();
  }

  // --- Toggle logic
  function setMode(mode){
    const sel = document.getElementById('type');
    sel.value = mode;

    document.getElementById('t-outside').classList.toggle('active', mode === 'outside');
    document.getElementById('t-inside').classList.toggle('active', mode === 'inside');

    calculate();
  }

  function setBottom(bt){
    const sel = document.getElementById('bottom-type');
    sel.value = bt;

    document.getElementById('t-binside').classList.toggle('active', bt === 'inside');
    document.getElementById('t-bbottom').classList.toggle('active', bt === 'bottom');

    calculate();
  }

  // --- One-click select + blue highlight
  function focusSelect(el){
    el.classList.add('oneclick-active');
    el.focus({preventScroll:true});
    requestAnimationFrame(() => {
      try { el.select(); } catch(e) {}
    });
  }

  function wireSelectAll() {
    document.querySelectorAll('input, textarea').forEach(el => {
      el.addEventListener('mousedown', (e) => {
        e.preventDefault();
        focusSelect(el);
      });
      el.addEventListener('touchstart', (e) => {
        e.preventDefault();
        focusSelect(el);
      }, {passive:false});

      el.addEventListener('focus', () => el.classList.add('oneclick-active'));
      el.addEventListener('blur', () => el.classList.remove('oneclick-active'));
    });
  }

  // --- Maserung: erstes eingegebenes Maß
  function onDimInput(which){
    if (!grainAxis) {
      grainAxis = (which === 'length') ? 'x' : 'z';
      updateWoodTextureOrientation();
    }
  }

  // --- Swap Länge/Breite
  function swapLW(){
    const l = document.getElementById('length');
    const w = document.getElementById('width');
    const tmp = l.value;
    l.value = w.value;
    w.value = tmp;
    calculate();
  }

  // --- 3D Wood Texture
  function makeBirchTextureCanvas(){
    const c = document.createElement('canvas');
    c.width = 512; c.height = 512;
    const ctx = c.getContext('2d');

    const g = ctx.createLinearGradient(0,0,512,512);
    g.addColorStop(0, '#f3e7cf');
    g.addColorStop(1, '#efe1c5');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,512,512);

    const img = ctx.getImageData(0,0,512,512);
    for (let i=0;i<img.data.length;i+=4){
      const n = (Math.random()*10)|0;
      img.data[i]   = Math.min(255, img.data[i]   + n);
      img.data[i+1] = Math.min(255, img.data[i+1] + n);
      img.data[i+2] = Math.min(255, img.data[i+2] + n);
    }
    ctx.putImageData(img,0,0);

    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = 'rgba(120,85,55,0.55)';
    ctx.lineWidth = 1;
    for (let y=0; y<512; y+=10){
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(512,y);
      ctx.stroke();
    }
    ctx.globalAlpha = 0.10;
    ctx.strokeStyle = 'rgba(120,85,55,0.35)';
    for (let y=5; y<512; y+=26){
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(512,y);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;
    return c;
  }

  function ensureWoodMaterial(){
    const canvas = makeBirchTextureCanvas();
    woodTex = new THREE.CanvasTexture(canvas);
    woodTex.wrapS = woodTex.wrapT = THREE.RepeatWrapping;
    woodTex.repeat.set(1.6, 1.6);
    woodTex.center.set(0.5,0.5);

    woodMat = new THREE.MeshLambertMaterial({ map: woodTex, color: 0xffffff });
    edgeMat = new THREE.LineBasicMaterial({ color: 0x94a3b8 });
    updateWoodTextureOrientation();
  }

  function updateWoodTextureOrientation(){
    if (!woodTex) return;
    woodTex.rotation = (grainAxis === 'z') ? Math.PI / 2 : 0;
    woodTex.needsUpdate = true;
  }

  // --- 3D
  function init3D() {
    const container = document.getElementById('canvas-container');
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 1, 20000);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const sun = new THREE.DirectionalLight(0xffffff, 0.35);
    sun.position.set(400, 600, 250);
    scene.add(sun);

    ensureWoodMaterial();

    window.addEventListener('resize', () => {
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });

    calculate();
    animate();
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  function calculate() {
    const d = dict[lang];

    const f = factorToMM(unit);
    const L_u = parseFloat(document.getElementById('length').value) || 0;
    const W_u = parseFloat(document.getElementById('width').value) || 0;
    const H_u = parseFloat(document.getElementById('height').value) || 0;
    const T_u = parseFloat(document.getElementById('thickness').value) || 0;
    const BT_u = parseFloat(document.getElementById('bottom-thick').value) || 0;
    const Q = Math.max(1, parseInt(document.getElementById('qty').value) || 1);

    const L = L_u * f;
    const W = W_u * f;
    const H = H_u * f;
    const T = T_u * f;
    const BT = BT_u * f;

    const bType = document.getElementById('bottom-type').value; // inside | bottom
    const mode = document.getElementById('type').value; // outside | inside

    let fL, sL, bL, bW, wallH;
    let outerL, outerW;

    if (mode === 'outside') {
      outerL = L;
      outerW = W;

      fL = L;
      sL = W - (2 * T);

      wallH = (bType === 'bottom') ? (H - BT) : H;

      if (bType === 'inside') {
        bL = L - (2 * T);
        bW = W - (2 * T);
      } else {
        bL = L;
        bW = W;
      }
    } else {
      outerL = L + (2 * T);
      outerW = W + (2 * T);

      fL = L + (2 * T);
      sL = W;

      wallH = H;

      bL = L;
      bW = W;
    }

    fL = Math.max(0, fL);
    sL = Math.max(0, sL);
    bL = Math.max(0, bL);
    bW = Math.max(0, bW);
    wallH = Math.max(0, wallH);

    const toUnit = (mm) => mm / f;

    const pretty =
`${2 * Q}x ${d.fr}    ${fmt(toUnit(fL))} × ${fmt(toUnit(wallH))} ${unit}
${2 * Q}x ${d.sides}  ${fmt(toUnit(sL))} × ${fmt(toUnit(wallH))} ${unit}
${1 * Q}x ${d.bottom} ${fmt(toUnit(bL))} × ${fmt(toUnit(bW))} ${unit}`;

    document.getElementById('cut-list-text').value = pretty;

    update3D({ outerL, outerW, bL, bW, wallH, T, BT, bType });

    // Area
    const area_mm2 = ((2 * fL * wallH) + (2 * sL * wallH) + (bL * bW)) * Q;
    const area_m2 = area_mm2 / 1_000_000;
    document.getElementById('val-area').innerText = area_m2.toFixed(2) + " m²";

    const price = parseFloat(document.getElementById('price-sqm').value) || 0;
    document.getElementById('val-price').innerText = (area_m2 * price).toFixed(2) + " €";

    // Volume
    let Lin, Win, Hin;
    if (mode === 'inside') {
      Lin = L; Win = W; Hin = H;
    } else {
      Lin = Math.max(0, L - 2 * T);
      Win = Math.max(0, W - 2 * T);
      Hin = Math.max(0, H - (bType === 'bottom' ? BT : 0));
    }

    const vol_mm3 = Lin * Win * Hin;
    const vol_liters = vol_mm3 / 1_000_000;
    document.getElementById('val-vol').innerText = vol_liters.toFixed(2) + " L";
  }

  function update3D({ outerL, outerW, bL, bW, wallH, T, BT, bType }) {
    if (!scene || !woodMat) return;

    parts.forEach(p => scene.remove(p));
    parts = [];

    const box = (w, h, d, x, y, z) => {
      if (w <= 0 || h <= 0 || d <= 0) return;
      const geo = new THREE.BoxGeometry(w, h, d);
      const mesh = new THREE.Mesh(geo, woodMat);
      mesh.position.set(x, y, z);
      mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo), edgeMat));
      scene.add(mesh);
      parts.push(mesh);
    };

    // Boden
    box(bL, BT, bW, 0, BT / 2, 0);

    // Wände
    const yBase = (bType === 'bottom') ? BT : 0;
    const yW = yBase + wallH / 2;

    const zOuterHalf = outerW / 2;
    const xOuterHalf = outerL / 2;

    box(outerL, wallH, T, 0, yW, (zOuterHalf - T / 2));
    box(outerL, wallH, T, 0, yW, -(zOuterHalf - T / 2));

    const sideDepth = Math.max(0, outerW - 2 * T);
    box(T, wallH, sideDepth, (xOuterHalf - T / 2), yW, 0);
    box(T, wallH, sideDepth, -(xOuterHalf - T / 2), yW, 0);

    // Camera framing
    const max = Math.max(outerL, outerW, wallH + BT);
    camera.position.set(max * 1.6, max * 1.2, max * 1.6);
    controls.target.set(0, (yBase + wallH) / 2, 0);
    controls.update();
  }

  function flashActive(btnId) {
    const btn = document.getElementById(btnId);
    btn.classList.add('active');
    setTimeout(() => btn.classList.remove('active'), 450);
  }

  // Copy: TSV – erste Zahl in Klammern
  function copyTableExcel() {
    const d = dict[lang];

    const Q = Math.max(1, parseInt(document.getElementById('qty').value) || 1);
    const wood = (document.getElementById('wood-type').value || "").trim();

    const f = factorToMM(unit);
    const L_u = parseFloat(document.getElementById('length').value) || 0;
    const W_u = parseFloat(document.getElementById('width').value) || 0;
    const H_u = parseFloat(document.getElementById('height').value) || 0;
    const T_u = parseFloat(document.getElementById('thickness').value) || 0;
    const BT_u = parseFloat(document.getElementById('bottom-thick').value) || 0;

    const L = L_u * f, W = W_u * f, H = H_u * f, T = T_u * f, BT = BT_u * f;
    const bType = document.getElementById('bottom-type').value;
    const mode = document.getElementById('type').value;

    let fL, sL, bL, bW, wallH;
    if (mode === 'outside') {
      fL = L;
      sL = W - (2 * T);
      wallH = (bType === 'bottom') ? (H - BT) : H;
      if (bType === 'inside') { bL = L - (2 * T); bW = W - (2 * T); }
      else { bL = L; bW = W; }
    } else {
      fL = L + (2 * T);
      sL = W;
      wallH = H;
      bL = L; bW = W;
    }

    fL = Math.max(0,fL); sL=Math.max(0,sL); bL=Math.max(0,bL); bW=Math.max(0,bW); wallH=Math.max(0,wallH);
    const toUnit = (mm) => mm / f;

    const modeLabel = (lang === 'de')
      ? (mode === 'outside' ? dict.de.outsideShort : dict.de.insideShort)
      : (mode === 'outside' ? dict.en.outsideShort : dict.en.insideShort);

    const dimsCol = `${unit} | ${modeLabel}`;

    const rows = [
      [`(${2*Q})`, d.fr,     fmt(toUnit(fL)),   fmt(toUnit(wallH)), dimsCol, wood],
      [`(${2*Q})`, d.sides,  fmt(toUnit(sL)),   fmt(toUnit(wallH)), dimsCol, wood],
      [`(${1*Q})`, d.bottom, fmt(toUnit(bL)),   fmt(toUnit(bW)),    dimsCol, wood],
    ];

    const tsv = [d.tableHeader, ...rows.map(r => r.join('\t'))].join('\n');

    navigator.clipboard.writeText(tsv).then(() => {
      flashActive('btn-copy');
      alert(dict[lang].copied);
    });
  }

  function genProjectId() {
    const now = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    const y = now.getFullYear();
    const m = pad(now.getMonth() + 1);
    const d = pad(now.getDate());
    const hh = pad(now.getHours());
    const mm = pad(now.getMinutes());
    const rand = Math.floor(Math.random() * 900 + 100);
    return `PRJ-${y}${m}${d}-${hh}${mm}-${rand}`;
  }

  function copyEmail() {
    const projectId = genProjectId();

    const wood = (document.getElementById('wood-type').value || "").trim();
    const thickness = (document.getElementById('thickness').value || "").trim();
    const qty = (document.getElementById('qty').value || "1").trim();
    const list = (document.getElementById('cut-list-text').value || "").trim();

    const subjectDE = `Anfrage Zuschnitt / Angebot – ${projectId}`;
    const subjectEN = `Cutting request / quotation – ${projectId}`;

    let body = "";
    if (lang === 'de') {
      body =
`BETREFF: ${subjectDE}

Sehr geehrte Damen und Herren,

bitte erstellen Sie mir ein Angebot für den Zuschnitt von Holzplatten für folgende Boxen.

Projekt: ${projectId}
Menge (Boxen): ${qty}

Material: ${wood}
Wandstärke: ${thickness} ${unit}

Stückliste:
${list}

Falls das gewünschte Material nicht verfügbar ist, bitte ich um ein Angebot für ein möglichst ähnliches Material (vergleichbare Qualität/Eigenschaften).

Vielen Dank!

Mit freundlichen Grüßen
Ein Kunde`;
    } else {
      body =
`SUBJECT: ${subjectEN}

Dear Sir or Madam,

please provide a quotation for cutting wood panels for the following boxes.

Project: ${projectId}
Quantity (boxes): ${qty}

Material: ${wood}
Wall thickness: ${thickness} ${unit}

Cutting list:
${list}

If the requested material is not available, please quote a suitable similar alternative (comparable quality/properties).

Thank you!

Kind regards,
A customer`;
    }

    navigator.clipboard.writeText(body).then(() => {
      flashActive('btn-mail');
      alert(dict[lang].mailcopied);
    });
  }

  window.onload = () => {
    wireSelectAll();
    init3D();
    setLang('de');

    setMode(document.getElementById('type').value || 'outside');
    setBottom(document.getElementById('bottom-type').value || 'inside');
  };
</script>

</body>
</html>
